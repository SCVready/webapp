{% extends "base.html" %}

<!-- Page Heading -->
{% block page_heading %}
<div class="row mb-3">
  <div class="col-5 col-sm-3">
    <h1 class="h3 mb-0 text-gray-800">Detection</h1>
  </div>

  <div class="col-7 col-sm-9">
    <div class="float-right">
      {% if det_started %}
      <button id="btn_start" class="btn btn-sm btn-primary shadow-sm disabled" onclick = 'start_det();'><i class="fas fa-bolt fa-sm text-white-50"></i> Start <span class="d-none d-sm-inline-block">Detection</span></button>
      <button id="btn_stop" class="btn btn-sm btn-primary shadow-sm" onclick = 'stop_det();'><i class="fas fa-power-off fa-sm text-white-50"></i> Stop <span class="d-none d-sm-inline-block">Detection</span></button>
      {% else %}
      <button id="btn_start" class="btn btn-sm btn-primary shadow-sm" onclick = 'start_det();'><i class="fas fa-bolt fa-sm text-white-50"></i> Start <span class="d-none d-sm-inline-block">Detection</span></button>
      <button id="btn_stop" class="btn btn-sm btn-primary shadow-sm disabled" onclick = 'stop_det();'><i class="fas fa-power-off fa-sm text-white-50"></i> Stop <span class="d-none d-sm-inline-block">Detection</span></button>
      {% endif %}
    </div>
  </div>
</div>
{% endblock %}

<!-- Content Row -->
{% block page_content %}
<div class="row">

  <div class="col-lg-6 mb-0">
    <!-- Approach -->
    <div class="card shadow mb-0">
      <div class="card-header py-2">
        <h6 class="m-0 font-weight-bold text-primary">Intrusions</h6>
      </div>
      <div class="card-body">
        <div class="table-responsive">
          <table class="table table-bordered" id="dataTable" width="100%" cellspacing="0">
            <thead>
              <tr>
                <th>Date</th>
                <th>Duration</th>
		            <th></th>
              </tr>
            </thead>
            <tbody>
            {% for det in detections %}
              <tr>
                <td><button onclick = "show_capture({{ det[0] }});" class="btn btn-sm btn-primary shadow-sm">{{ det[1] }}</button></td>
                <td>{{ det[2] }}</td>
                <td>
                  <div class="text-right">
                    <button class="btn btn-light btn-circle btn-sm" onclick = "delete_detection(this,{{ det[0] }});">
                      <i class="fas fa-times"></i>
                    </button>
                  </div>
	              </td>
              </tr>
	          {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>

  </div>

  <div class="col-lg-6 mb-0">
    <!-- Illustrations -->
    <div class="card shadow mb-0">
      <div class="card-header py-2">
        <h6 class="m-0 font-weight-bold text-primary">Capture</h6>
      </div>
      <div class="card-body">
        <div class="text-center">
          {% if det_num > 0 %}
          <img id="capture" class="img-fluid px-0 px-sm-0 mt-0 mb-4" style="width: 100%" src="detection/{{ (detections|last)[0] }}/2" alt="">
          {% else %}
          <img id="capture" class="img-fluid px-0 px-sm-0 mt-0 mb-4" style="width: 100%" src="images/placeholder.jpeg" alt="">
          {% endif %}
          <p class="mb-2">Data</p>
          <p class="mb-2">Data</p>
          <p class="mb-2">Data</p>
        </div>
      </div>
    </div>

  </div>

</div>
{% endblock %}


{% block page_script %}
<script type="text/javascript" charset="utf-8">
  function start_det(){
    $.post( "/api/det_status",{ det: "start"} ,function( data ){
      if( data == 'ok'){
          $("#btn_start").addClass("disabled");
          $("#btn_stop").removeClass("disabled");
          $("#summary_det_status").removeClass("bg-primary").addClass("bg-warning");
        }
      else{
          console.log("ERROR");
      }
    });
  };
  function stop_det(){
    $.post( "/api/det_status",{ det: "stop"} ,function( data ){
      if( data == 'ok'){
          $("#btn_start").removeClass("disabled");
          $("#btn_stop").addClass("disabled");
          $("#summary_det_status").removeClass("bg-warning").addClass("bg-primary");
        }
      else{
          console.log("ERROR");
      }
    });
  };

  function show_capture(num_det) {
    var img = document.getElementById("capture");
    img.src = "detection/"+num_det+"/2";
  };

  function delete_detection(button,id) {
    $.post( "/api/delete_detection",{ delete_detection: id} );
    det_table.row(button.parentNode.parentNode).remove().draw(false);
  };
  
  function update_detection_table() {

    var socketio = io.connect(location.protocol + '//' + document.domain + ':' + location.port);

    socketio.on('connect', function() {
      socketio.emit('my event', {data: 'I\'m connected!'});
    });
    
    socketio.on('kinectalarm_event', function(data) {
      var event_words = data.frame.split(' ');
      var num_event_words = event_words.length;
      
      if(num_event_words == 3){
        if(event_words[0] == 'newdet'){
          setTimeout(function() {
            det_table.row.add( [
              '<button onclick = "show_capture('+event_words[1]+');" class="btn btn-sm btn-primary shadow-sm">'+event_words[2]+'</button>',
              '5',
              '<div class="text-right"><button class="btn btn-light btn-circle btn-sm" onclick = "delete_detection(this,'+event_words[1]+');"><i class="fas fa-times"></i></button></div>',
              ] ).draw( false );
            show_capture(event_words[1]);
          }, 2000);
        }
      }
    });
  };

  update_detection_table();

  // Call the dataTables jQuery plugin
  $(document).ready(function() {
    det_table = $('#dataTable').DataTable( {
        "order": [[ 0, "desc" ]]
    } );
  });
  
  $('#dataTable').on("click", "button", function(){
    det_table.row($(this).parents('div').parents('tr')).remove().draw(false);
  });

</script>

{% endblock %}

