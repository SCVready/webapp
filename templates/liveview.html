{% extends "base.html" %}

<!-- TOP PANEL  -->
{% block top_panel %}
<div class="container">
	<div class="row center">
		<h5 class="header col s12 light">Control Liveview</h5>
	</div>
	<div class="row center">
		<form action="" method="post">
			{% if lvw_started %}
			<button class="btn-large waves-effect waves-light orange disabled ale_btn" name="liveview" value="start">Start</button>
			<button class="btn-large waves-effect waves-light orange ale_btn" name="liveview" value="stop">Stop</button>
			{% else %}
			<button class="btn-large waves-effect waves-light orange ale_btn" name="liveview" value="start">Start</button>
			<button class="btn-large waves-effect waves-light orange disabled ale_btn" name="liveview" value="stop">Stop</button>
			{% endif %}
		</form>
	</div>
</div>
{% endblock %}
<!-- CONTENT  -->
{% block content %}
<div class="row center">
	<h1><img id="liveview_img" class="responsive-img"></h1>
</div>
{% endblock %}

<!-- SCRIPTS -->
{% block scripts %}
<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/socket.io/1.3.6/socket.io.min.js"></script>

<script type="text/javascript" charset="utf-8">

$.get( "/api/liveview", function( data ) {
  if (data == "True") {
    open_socketio()
  }
});

function _arrayBufferToBase64( buffer ) {
    var binary = '';
    var bytes = new Uint8Array( buffer );
    var len = bytes.byteLength;
    for (var i = 0; i < len; i++) {
        binary += String.fromCharCode( bytes[ i ] );
    }
    return window.btoa( binary );
}

function open_socketio() {
	var socket = io.connect(location.protocol + '//' + document.domain + ':' + location.port);
	socket.on('connect', function() {
		socket.emit('my event', {data: 'I\'m connected!'});
	});
	socket.on('my event', function(data) {
		var img = document.getElementById("liveview_img");
		img.src = 'data:image/jpg;base64,' + _arrayBufferToBase64(data.frame);
	});
}
</script>
{% endblock %}
